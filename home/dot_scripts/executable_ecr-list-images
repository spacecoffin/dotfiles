#!/usr/bin/env bash
# ecr-list-images - List ECR images sorted by push timestamp (desc), fallback to imageTag
# Usage: ecr-list-images <repository-name> [region]

set -euo pipefail

if [[ $# -lt 1 ]]; then
    echo "Usage: $(basename "$0") <repository-name> [region]" >&2
    exit 1
fi

REPO="$1"
REGION="${2:-us-east-1}"

aws ecr describe-images \
    --repository-name "$REPO" \
    --region "$REGION" \
    --output json \
| jq -r '
  [.imageDetails[] | {
    tag:       (.imageTags[0] // "(untagged)"),
    all_tags:  (.imageTags // [] | join(", ")),
    digest:    .imageDigest,
    pushed_at: (.imagePushedAt // ""),
    size_mb:   (.imageSizeInBytes // 0 | . / 1048576 | floor)
  }]
  | sort_by(.pushed_at, .tag)
  | reverse
  | .[]
  | "\(if .pushed_at == "" then "(no timestamp)        " else .pushed_at end)\t\(.size_mb)MB\t\(.all_tags)\t\(.digest)"
'
